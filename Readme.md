README
======

Проблема
--------

При тестировании высоконагруженной операции списания средств с баланса возникли две основные проблемы:

1.  **Ограниченная пропускная способность машины** — высокая нагрузка на процессор (100%) и частые сбои, включая "синие экраны смерти".
    
2.  **Ограничение на количество подключений к PostgreSQL** — при высокой конкурентной нагрузке база данных перестает справляться с объемом соединений.
    

Попытки решения через многопоточность в Node.js (кластеры) и настройки железа не дали стабильного результата.

Решение
-------

Использование очереди задач позволяет:

*   Обрабатывать запросы последовательно, избегая перегрузки системы.
    
*   Гарантировать корректное списание средств, предотвращая гонку состояний.
    
*   Контролировать лимиты нагрузки на PostgreSQL, избегая исчерпания соединений.
    

Реализация
----------

1.  **Очередь на Redis с BullMQ**
    
    *   Запросы на списание помещаются в очередь.
        
    *   В фоне работает обработчик, который забирает задачи и исполняет их последовательно.
        
    *   Если средств на балансе недостаточно — отправляется корректный ответ об ошибке.
        
2.  **Мониторинг и логирование**
    
    *   Ведется учет выполненных списаний и ошибок.
        
    *   В случае задержек в обработке запросов можно динамически настраивать число воркеров.
        

Итог
----

После внедрения очереди система стабильно обрабатывает все запросы без перегрузки процессора и с контролируемой нагрузкой на базу данных. 5000 успешных списаний и 5000 корректных отказов при недостатке средств обрабатываются без сбоев.

P.S
----

Тесты проводил при помощи библиотеки artillery[https://www.npmjs.com/package/artillery](https://www.npmjs.com/package/artillery)